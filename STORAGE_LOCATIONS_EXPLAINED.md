# üìç Exact Storage Locations for `storeInPostgres` and `storeInMongoDB`

## üîç `storeInPostgres()` Function

### **Database:**
- **Name:** `smart_storage`
- **Location:** PostgreSQL (Docker container `smart_storage_postgres` or Supabase)
- **Connection Config:** `backend/src/config/knex.config.js`
- **Default:** `process.env.PG_DATABASE || 'smart_storage'`

### **Table Name:**
- **Pattern:** `dataset_<name>_<shortId>`
- **Generated by:** `schemaGenerator.generateTableName(finalDatasetName, datasetId)`
- **Example:** `dataset_sql3_12090a9b`

### **Code Location:**
```javascript
// File: backend/src/services/catalog.service.js
// Lines: 396-427

async storeInPostgres(tableName, ddl, data) {
  try {
    // Step 1: Create table using DDL
    await db.raw(ddl);  // Creates table: dataset_<name>_<shortId>
    
    // Step 2: Flatten and insert data
    const flattenedData = dataArray.map(record =>
      jsonPipeline.flattenObject(record)
    );
    
    // Step 3: Insert into the table
    await db(tableName).insert(flattenedData);  // ‚Üê INSERT HERE
    //         ^^^^^^^^^
    //         This is the table name passed as parameter
    //         Format: dataset_<name>_<shortId>
    
    logger.info(`Stored ${flattenedData.length} record(s) in table: ${tableName}`);
  }
}
```

### **How Table Name is Generated:**
```javascript
// File: backend/src/jsonPipeline/json.orchestrator.js
// Lines: 22-23

const datasetId = uuidv4();  // Full UUID: e.g., "53ee7c71-36fe-4599-bd63-7da7bdbddb8b"
const tableName = schemaGenerator.generateTableName(finalDatasetName, datasetId);
// Example result: "dataset_sql3_12090a9b"
```

**Table Name Generation Logic:**
```javascript
// File: backend/src/services/schema-generator.service.js
// Lines: 178-185

generateTableName(originalName, datasetId) {
  const baseName = originalName
    .replace(/\.[^/.]+$/, '')  // Remove file extension
    .toLowerCase()
    .replace(/[^a-z0-9_]/g, '_');  // Replace special chars with underscore
  
  const shortId = datasetId.substring(0, 8);  // First 8 chars of UUID (keeps dashes if present)
  
  return `dataset_${this.sanitizeIdentifier(baseName)}_${shortId}`;
}
// Example: "sql3.json" + "53ee7c71-36fe-4599-bd63-7da7bdbddb8b"
// Result: "dataset_sql3_53ee7c71"
```

### **Real Examples from Your Database:**
```
‚úÖ dataset_sql2_65f59e9a
‚úÖ dataset_sql3_12090a9b
‚úÖ dataset_sql3_81a6b8d4
‚úÖ dataset_sql3_8d23c671
‚úÖ dataset_sql4_8086e2dd
```

### **Complete Storage Path:**
```
PostgreSQL Database: smart_storage
  ‚îî‚îÄ‚îÄ Table: dataset_<name>_<shortId>
      ‚îî‚îÄ‚îÄ Data: Flattened JSON records
```

---

## üîç `storeInMongoDB()` Function

### **Database:**
- **Name:** `smart_storage`
- **Location:** MongoDB (Docker container `smart_storage_mongodb`)
- **Connection Config:** `backend/src/config/mongoose.js`
- **Connection URI:** `mongodb://admin:admin@localhost:27017/smart_storage?authSource=admin`
- **Database Name:** Extracted from URI ‚Üí `smart_storage`

### **Collection Name:**
- **Pattern:** `dataset_<fullUUID>`
- **Generated by:** `const collectionName = \`dataset_${datasetId}\``
- **Example:** `dataset_53ee7c71-36fe-4599-bd63-7da7bdbddb8b`

### **Code Location:**
```javascript
// File: backend/src/services/catalog.service.js
// Lines: 435-470

async storeInMongoDB(datasetId, data) {
  try {
    // Step 1: Generate collection name
    const collectionName = `dataset_${datasetId}`;  // Format: dataset_<fullUUID>
    //         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //         Example: "dataset_53ee7c71-36fe-4599-bd63-7da7bdbddb8b"
    
    // Step 2: Get MongoDB connection
    const mongoose = (await import('mongoose')).default;
    const db = mongoose.connection.db;  // ‚Üê Database: smart_storage
    const collection = db.collection(collectionName);  // ‚Üê Collection: dataset_<uuid>
    
    // Step 3: Add metadata and insert
    const documents = dataArray.map(record => ({
      ...record,
      _datasetId: datasetId,
      _importedAt: new Date(),
    }));
    
    // Step 4: Insert into collection
    const result = await collection.insertMany(documents);  // ‚Üê INSERT HERE
    //         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //         Inserts into: smart_storage.dataset_<uuid>
    
    logger.info(`Stored ${result.insertedCount} record(s) in collection: ${collectionName}`);
  }
}
```

### **How Collection Name is Generated:**
```javascript
// File: backend/src/jsonPipeline/json.orchestrator.js
// Line: 22

const datasetId = uuidv4();  // Full UUID: e.g., "53ee7c71-36fe-4599-bd63-7da7bdbddb8b"

// Then in storeInMongoDB:
const collectionName = `dataset_${datasetId}`;
// Result: "dataset_53ee7c71-36fe-4599-bd63-7da7bdbddb8b"
```

### **Real Examples from Your Database:**
```
‚úÖ dataset_75fb0f06-30e5-4fdf-a511-f2de69fdea36
‚úÖ dataset_da9da1ec-182d-4ecb-b666-c3f25080f8b7
‚úÖ dataset_434a4b35-db9b-4248-8e92-9c8e94889310
‚úÖ dataset_53ee7c71-36fe-4599-bd63-7da7bdbddb8b
‚úÖ dataset_34077a90-e890-4933-9229-57a03cb61777
```

### **Complete Storage Path:**
```
MongoDB Database: smart_storage
  ‚îî‚îÄ‚îÄ Collection: dataset_<fullUUID>
      ‚îî‚îÄ‚îÄ Documents: JSON records (with _datasetId and _importedAt metadata)
```

---

## üìä Side-by-Side Comparison

| Aspect | `storeInPostgres()` | `storeInMongoDB()` |
|--------|---------------------|-------------------|
| **Database** | `smart_storage` (PostgreSQL) | `smart_storage` (MongoDB) |
| **Storage Unit** | Table | Collection |
| **Naming Pattern** | `dataset_<name>_<shortId>` | `dataset_<fullUUID>` |
| **ID Format** | First 8 chars of UUID (no dashes) | Full UUID (with dashes) |
| **Example** | `dataset_sql3_12090a9b` | `dataset_53ee7c71-36fe-4599-bd63-7da7bdbddb8b` |
| **Data Format** | Flattened (nested ‚Üí flat columns) | Preserved (nested structure intact) |
| **Metadata** | None (just columns) | `_datasetId`, `_importedAt` added |
| **Code Location** | `catalog.service.js:396` | `catalog.service.js:435` |

---

## üîó Connection Details

### **PostgreSQL Connection:**
```javascript
// Config: backend/src/config/knex.config.js
// Database: process.env.PG_DATABASE || 'smart_storage'
// Connection: Uses Knex.js with 'pg' client
// Access: db(tableName).insert(data)
```

### **MongoDB Connection:**
```javascript
// Config: backend/src/config/mongoose.js
// Database: Extracted from MONGO_URI ‚Üí 'smart_storage'
// Connection: Uses Mongoose with native MongoDB driver
// Access: mongoose.connection.db.collection(collectionName).insertMany(data)
```

---

## üìù Summary

### **`storeInPostgres()` stores data in:**
- **Database:** `smart_storage` (PostgreSQL)
- **Table:** `dataset_<name>_<shortId>` (e.g., `dataset_sql3_12090a9b`)
- **Code:** `await db(tableName).insert(flattenedData)`

### **`storeInMongoDB()` stores data in:**
- **Database:** `smart_storage` (MongoDB)
- **Collection:** `dataset_<fullUUID>` (e.g., `dataset_53ee7c71-36fe-4599-bd63-7da7bdbddb8b`)
- **Code:** `await collection.insertMany(documents)`

Both functions store data in the **`smart_storage`** database, but:
- PostgreSQL uses **tables** with short IDs
- MongoDB uses **collections** with full UUIDs

